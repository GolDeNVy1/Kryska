const { EmbedBuilder, ActivityType } = require('discord.js');
const { Events } = require('kazagumo');

module.exports = {
    name: Events.PlayerEmpty,
    async execute(client, player) {
        let disconnectTimeout;

        const lastMessage = player.data.get("message");
        if (lastMessage && lastMessage.deletable) {
            try {
                await lastMessage.delete();
            } catch (error) {
                if (error.code === 10008) {
                    console.warn(`–°–æ–æ–±—â–µ–Ω–∏–µ —Å ID ${lastMessage.id} —É–∂–µ —É–¥–∞–ª–µ–Ω–æ.`);
                } else {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è "Now Playing":', error);
                }
            }

            player.data.delete("message");
        }

        if (!player.queue.length) {
            const embed = new EmbedBuilder()
                .setColor(0xff0000)
                .setDescription('–†–µ–ø–µ—Ä—Ç—É–∞—Ä –∑–∞–∫–æ–Ω—á–∏–ª—Å—è, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –∑–∞–∫–∞–∂–∏ –µ—â—ë –ø–µ—Å–µ–Ω–∫—É).');

            const channel = client.channels.cache.get(player.textId);
            if (channel) await channel.send({ embeds: [embed] });

            if (player.data.has("disconnectTimeout")) {
                clearTimeout(player.data.get("disconnectTimeout"));
                player.data.delete("disconnectTimeout");
            }
            
            disconnectTimeout = setTimeout(async () => {
                if (!player.queue.length) {
                    await player.destroy();
            
                    const embed = new EmbedBuilder()
                        .setColor(0xff0000)
                        .setDescription('–Ø –ø–æ–π–¥—É, —É –º–µ–Ω—è –µ—â—ë –º–Ω–æ–≥–æ –¥–µ–ª, –ø–æ–∑–æ–≤—ë—Ç–µ –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç —Å–∫—É—á–Ω–æ –±–µ–∑ –º—É–∑—ã–∫–∏ ;)');
            
                    const textChannel = client.channels.cache.get(player.textId);
                    if (textChannel) await textChannel.send({ embeds: [embed] });
                }
            }, 60000);
            
            player.data.set("disconnectTimeout", disconnectTimeout);
            
        }
        await pickPresence();
    

    async function pickPresence () {
        try {
            await client.user.setPresence({
                activities: [
                    {
                        name: "–ï–º —Å—ã—Ä üßÄ",
                        type: ActivityType.Custom,
                    },
                ],
                status: 'idle',
            })
        } catch (error) {
            console.error(error);
        }
    }
}};